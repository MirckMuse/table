{"version":3,"file":"index.esm.js","sources":["../src/runIdleTask.ts","../src/binaryFind.ts"],"sourcesContent":["type TaskCallback = () => void;\n\n\n/**\n * 创建请求空闲回调函数\n * @returns {Function} 返回请求空闲回调函数\n */\nfunction createRequestIdleCallback() {\n  return window.requestIdleCallback || function (callback: IdleRequestCallback, options?: IdleRequestOptions) {\n    const _startTime = performance.now();\n\n    return window.requestAnimationFrame((time) => {\n      callback({\n        didTimeout: false,\n        timeRemaining: () => Math.max(0, 50 - (_startTime - time))\n      })\n    })\n  }\n}\n\nexport const requestIdleCallback = createRequestIdleCallback();\n\nconst BufferTime = 0;\n\n/**\n * 创建一个执行空闲任务的函数\n */\nfunction createRunIdleTask() {\n  /**\n   * 存储任务的数组\n   */\n  const tasks: TaskCallback[] = [];\n  /**\n   * 标志是否正在运行\n   */\n  let isRunning = false;\n\n  /**\n   * 判断是否有空闲时间\n   * @param deadline 空闲截止时间\n   * @returns 是否有空闲时间\n   */\n  function isIdea(deadline: IdleDeadline) {\n    const ideaTime = deadline.timeRemaining();\n    return BufferTime < ideaTime;\n  }\n\n  /**\n   * 执行空闲任务\n   */\n  function _run() {\n    isRunning = true;\n\n    requestIdleCallback((deadline) => {\n      if (!tasks.length) {\n        isRunning = false;\n        return;\n      }\n\n      while (tasks.length && isIdea(deadline)) {\n        let _task: any = tasks.shift();\n\n        if (_task) {\n          _task();\n          // 设置函数为空，及时触发垃圾回收，避免内存泄漏\n          _task = null;\n        }\n      }\n      _run();\n    })\n  }\n\n  /**\n   * 返回一个用于添加任务的函数\n   * @param task 任务函数\n   */\n  return function (task: TaskCallback) {\n    tasks.push(task);\n\n    if (isRunning) return;\n    _run();\n  }\n}\n\n// 闲置时执行任务。用于对正确性没那么强的一些任务。\n// 单个任务尽可能耗时小。\nexport const runIdleTask = createRunIdleTask();\n","/**\n * 二分搜索一个范围内数据的索引, 当精确值找不到时，则返回一个近似值的索引\n * @param sortedArray 排序后的数组\n * @param compareFn  0 - 当前值  大于0 - 右区间 小于0 - 左区间\n * @returns \n */\nexport function binaryFindIndexRange<T = unknown>(sortedArray: T[], compareFn: (value: T, index: number) => number): number {\n  let left = 0;\n  let right = sortedArray.length - 1;\n\n  let rangeIndex = null;\n\n  while (left <= right) {\n    const middleIndex = Math.floor((left + right) / 2);\n    const middleValue = sortedArray[middleIndex];\n    const compare = compareFn(middleValue, middleIndex);\n\n    if (compare === 0) {\n      return middleIndex\n    }\n    if (compare > 0) {\n      left = middleIndex + 1\n    } else {\n      if (rangeIndex === null || rangeIndex > middleIndex) {\n        rangeIndex = middleIndex;\n      }\n      right = middleIndex - 1;\n    }\n  }\n\n  return rangeIndex ?? -1;\n}"],"names":[],"mappings":"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"}